{% extends 'social_distribution/base.html' %}
{% load static %}

{% block content %}

<!-- Container for all posts -->
<div class="content">
  <h2>Your Stream</h2>
  <!-- Checkbox to filter friends-only posts -->
  <label for="friendsOnlyFilter">
    <input type="checkbox" id="friendsOnlyFilter"> Show Friends Posts Only
  </label>
  {% for post in posts %}
  <!-- Each post in its own block with margin, border, and padding -->
  <div style="margin-bottom: 1em; border: 1px solid #ccc; padding: 1em;" class="post" data-visibility="{{ post.visibility }}">
    
    <p>
      {% if post.author.profile_image and post.author.profile_image.url %}
        <!-- Author has an uploaded profile image -->
        <img src="{{ post.author.profile_image.url }}" alt="Profile Picture" class="avatar">
      {% else %}
        <!-- Author does not have a profile image: show default avatar -->
        <img src="{% static 'img/avatar.png' %}" alt="Default Profile Picture" class="avatar">
      {% endif %}
      <strong>{{ post.author.display_name }}</strong>
    </p>
    

    {% if post.text %}
      <!-- If 'content_type' was text/markdown, post.text is HTML -->
      <div>{{ post.text|safe }}</div>
    {% endif %}

    {% if post.image %}
      <img src="{{ post.image.url }}" alt="Post Image" class="post-image">
    {% endif %}

    {% if post.video %}
      <video class="post-video" controls>
        <source src="{{ post.video.url }}" type="video/mp4">
        Your browser does not support the video tag.
      </video>
    {% endif %}

    <p class="post-meta">Posted on {{ post.created_at }}</p>

    {% if user.is_authenticated and author is not None %}
      <form method="post" action="{% url 'like_post' author.id post.id %}" class="like-post" likes="{{ post.likes.src }}" author="{{ author.id }}">
        {% csrf_token %}
        <input type="hidden" name="type" value="like">
        <!-- Icon button for liking -->
        <button type="submit" class="like-icon-btn">
          <img src="{% static 'img/heart.png' %}" alt="Like" class="like-icon">
        </button>
        <!-- Non-clickable text for like count -->
        <span class="like-text">Likes: <span class="like-count">{{ post.likes.count }}</span></span>
      </form>
    {% endif %}


    <h3>Comments</h3>
    <div class="comments">
      <ul>
        {% for comment in post.comments %}
          <li class="comment">
            <span>{{ comment.author.displayName }}: {{ comment.comment }}</span>
            {% if user.is_authenticated and author is not None %}
            <form method="post" action="{% url 'like_comment' author.id comment.id %}" class="like-comment" likes="{{ comment.likes.src }}" author="{{ author.id }}">
              {% csrf_token %}
              <input type="hidden" name="type" value="like">
              <!-- Icon button for liking the comment -->
              <button type="submit" class="like-icon-btn">
                <img src="{% static 'img/heart.png' %}" alt="Like" class="like-icon">
              </button>
              <!-- Non-clickable like text with bold styling -->
              <span class="like-text"><strong> <strong class="like-count">{{ comment.likes.count }}</strong></strong></span>
            </form>
          {% endif %}

          </li>
        {% endfor %}
      </ul>
    </div>

    {% if post.visibility == 'PUBLIC' or post.visibility == 'UNLISTED'  %}
        <!-- Button for copying link to posts -->
        <button type="button" class="copy-post-link btn" data-copy="{{ request.scheme }}://{{ request.get_host }}/authors/{{ post.author.id }}/posts/{{ post.id }}/view/">
            <span class="copy-label">Copy Link</span>
        </button>
    {% endif %}

    {% if user.is_authenticated and author is not None %}
      <div class="add-comment">
        <form method="post" action="{% url 'commented' author.id %}" class="comment-form">
          {% csrf_token %}
          <input type="hidden" name="type" value="comment">
          <textarea name="comment" rows="2" placeholder="Write a comment..."></textarea>
          <input type="hidden" name="post" value="{{ post.id }}">
          <input type="hidden" name="contentType" value="text/plain">
          <button type="submit" class="btn btn-comment">Comment</button>
        </form>
      </div>
    {% endif %}
  </div> <!-- end single post container -->
  {% endfor %}
</div> <!-- end all-posts container -->

<!-- Show alert for failed post viewing -->
{% if alert_message %}
<script>
  document.addEventListener("DOMContentLoaded", function() {
      const alertMessage = "{{ alert_message }}";
      if (alertMessage) {
          alert(alertMessage);
      }
  });
</script>
{% endif %}

<!-- to filter posts based on friends-only checkbox -->
<script>
document.addEventListener("DOMContentLoaded", function() {
  const checkbox = document.getElementById("friendsOnlyFilter");
  checkbox.addEventListener("change", function() {
    const posts = document.querySelectorAll(".post");
    posts.forEach(function(post) {
      if (checkbox.checked) {
        if (post.getAttribute("data-visibility") !== "FRIENDS") {
          post.style.display = "none";
        } else {
          post.style.display = "";
        }
      } else {
        post.style.display = "";
      }
    });
  });
});
</script>

{% endblock %}
